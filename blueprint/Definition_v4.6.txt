DGFS 프로젝트 정의서 (Ver 4.6)

1. 개요 (Overview)
- 프로젝트명: DGFS (Dad's Game For Son) - Seoho ROGUE
- 개발자: 아빠 (Admin & Developer)
- 주요 사용자: 초등학생 아들 (Player)
- 플랫폼: Windows 기반 실행 파일(.exe)
- 개발 언어: Python (PyGame, SQLite)
- 버전: Ver 4.6 (SFX Implementation)

2. 기획 의도 및 핵심 컨셉
아들이 좋아하는 캐릭터들로 즐길 수 있는 개인 맞춤형 로그라이크 RPG. '영구적인 성장'의 재미와 '한 판의 도전'이라는 로그라이크의 긴장감을 동시에 제공하는 것을 목표로 한다.

- **수집 (Collection)**: 다양한 IP의 캐릭터를 '뽑기'로 수집하여 나만의 파티를 구성하는 재미.
- **전투 (Strategic Battle)**: 민첩(AGI) 스탯에 따라 행동 순서가 결정되는 2:2 턴제 전투. 전략적인 파티 구성이 중요.
- **탐험 (Roguelike Exploration)**: 100층의 탑을 오르며 매번 다른 테마의 적과 조우하고, 전투 후 주어지는 랜덤 보상을 통해 캐릭터를 성장시키는 로그라이크 방식의 플레이.
- **이중 성장 (Dual Growth)**: 등반 중에만 유효한 '임시 성장'과 뽑기를 통해 얻는 '영구 성장'을 결합한 하이브리드 성장 시스템.

3. 시스템 아키텍처 (System Architecture)
MVC (Model-View-Controller) 패턴을 적용하여 각 모듈의 독립성과 유지보수성을 확보한다.
- **Model**: `game_systems/` (핵심 로직, 데이터 규칙)
- **View**: `ui/` (화면 렌더링, 시각 요소)
- **Controller**: `scenes/` (Model과 View 중재, 게임 흐름 제어)

3.1. 기술 스택
- **주요 언어**: Python 3.12+
- **게임 프레임워크**: Pygame
- **데이터베이스**: SQLite (파이썬 내장)
- **데이터 처리**: Pandas (CSV 마스터 데이터 로드 시 사용)
- **개발 도구**: Visual Studio Code, Git (GitHub Desktop)
- **배포**: PyInstaller (.exe 패키징)

4. 데이터베이스 설계 (Database Schema)
- `users`: 유저의 재화(티켓) 및 등반 진행 상황(`current_floor`)을 저장.
- `characters`: 캐릭터 원본 데이터. (CSV 로드)
    - 컬럼: id, name, origin, grade, attribute, hp, mp, atk, def, agi, sp_max, description, image
    - **[New] `sfx_type`**: 공격 사운드 타입 (`SWORD`: 검격음, 그 외: 일반 타격음).
    - **[New] `skill_name`**: 일반 스킬 이름.
    - **[New] `ult_name`**: 필살기 이름.
- `enemies`: 적 원본 데이터. (CSV 로드)
- `inventory`: 유저 보유 캐릭터 (영구/임시 성장 데이터 포함).
- `used_coupons`: 사용된 쿠폰 기록.

5. 상세 게임 규칙 (Game Rules)

5.1. 이중 성장 시스템 (Dual Growth System)
- **영구 성장**: **뽑기(Gacha)에서 중복 캐릭터** 획득 시 얻는 경험치로 성장. 게임 전체에 영구적으로 적용.
- **임시 성장**: **등반 중 전투 승리** 및 **보상 선택**으로 성장. 현재 등반 세션에서만 유효하며, 로비로 돌아가면 초기화.
- **초기화 규칙 (Initialization)**: 등반 시작('새로 하기') 시, 반드시 **인벤토리(DB)에 저장된 영구 레벨과 스탯**을 불러와 적용해야 한다. (1레벨 초기화 금지)
...

5.2. 전투 시스템 (Battle System)
- **전투 방식**: 2:2 턴제 전투. 캐릭터의 민첩(AGI) 스탯 총합이 높은 팀이 선공.
- **턴 순서**: 각 캐릭터의 AGI 스탯에 따라 행동 게이지가 차오르며, 가장 먼저 100%에 도달한 캐릭터가 행동 턴을 가짐.
- **전투 AI**: 
    - **적 AI (구현 완료)**: 적은 `config.AI_SKILL_CHANCE` 확률에 기반해 스킬 또는 일반 공격을 자동으로 수행한다.
- **상태 유지 (Persistence)**:
    - **세션 유지**: 등반 중에는 DB를 다시 읽지 않고, 메모리 상의 파티 상태(HP, MP, 임시 성장, 사망 여부)를 다음 층으로 전달한다.
    - **보상 적용**: 전투/층 보상 선택 즉시 캐릭터 객체에 반영하며, 이 상태는 세션이 유지되는 한 영구적이다.
    - **사망 패널티**: 사망한 캐릭터(`HP <= 0`)는 해당 챕터(10층 단위) 보스를 클리어하거나 부활 이벤트를 겪기 전까지 전투에 참여할 수 없다. (층 이동 시 자동 부활 금지)
- **[New] 사운드 연출 (SFX)**:
    - **공격음**: 캐릭터의 `sfx_type` 데이터에 따라 `_sword` 또는 `_hit` 계열 사운드를 재생한다.
    - **스킬/필살기음**: 공격음과 동일한 로직으로 `sfx_type`에 맞춰 분기한다.

5.3. 등반 및 로그라이크 규칙 (Climb & Roguelike Rules)
- **등반 구조**: 총 100층으로 구성되며, 10층마다 보스가 등장.
- **테마 (Biome)**: `Mario`, `Pokemon`, `DemonSlayer` 3개 테마가 각 Phase(30층 단위)마다 랜덤한 순서로 등장하며, `Final` 테마(91~100층)는 고정.
- **상태 유지 (Persistence)**: 다음 층으로 이동 시, 전투가 끝난 시점의 HP/MP 상태가 그대로 유지된다.
- **사망 및 부활 (Permadeath & Restore)**:
    - **사망 패널티**: 일반 층에서 캐릭터가 사망하면, 해당 챕터(10층 단위)가 끝날 때까지 부활할 수 없다.
    - **완전 회복**: 10층 단위의 보스를 클리어하면, 사망한 캐릭터를 포함한 파티 전원이 부활하고 HP/MP가 100% 회복된다.
- **저장 및 이어하기**: '저장하고 나가기' 선택 시, 현재 층과 캐릭터 상태가 모두 DB에 저장되어 등반을 중단하고 이어할 수 있다.

5.4. 전투 보상 시스템 (Battle Reward System)
- **보상 획득**: 전투 승리 시, 3개의 랜덤 보상이 제시된다.
- **보상 종류**: `체력 회복`, `최대 체력 증가`, `공격력 증가` 등 임시 성장과 `뽑기권` 등 재화 보상으로 구성.
- **적용 시점**: 보상을 선택한 후 **'다음 층으로 가기' 또는 '저장하고 나가기' 버튼을 눌러야** 선택한 보상의 효과가 최종적으로 적용된다.

5.5. 뽑기 시스템 (Gacha System)
- **재화**: '뽑기권(Ticket)'을 사용하여 캐릭터를 획득.
- **등급 및 확률**: Mythic(0.05%) ~ Common(90%) 5단계.
- **중복 보상**: 이미 보유한 캐릭터 획득 시, 등급에 따라 '영구 경험치'를 차등 지급.

5.6. 쿠폰 시스템 (Coupon System)
- **코드 구조**: `발급자(3자리)` + `날짜(YYMMDD)` + `등급(1자리)` 조합.
- **보상**: 코드의 등급에 따라 '뽑기권'을 차등 지급. 동일 날짜의 코드는 중복 사용 불가.

6. 개발 로드맵 (Development Phases)
... (이전 페이즈 생략) ...
**Phase 4.22 (System Definition Update) [Done]**
- **Goal:** 프로젝트의 모든 기획/규칙을 문서화하고, 코드와의 불일치를 해소.
- **Tasks:** `Definition.txt` 및 `Code_structure.txt` 최신화.

**Phase 4.23 (Climbing System Stabilization) [Done]:**
- **Goal:** 등반 시스템의 핵심 버그를 수정하고 데이터 정합성을 확보하여 안정적인 플레이 경험을 제공.
- **Tasks:**
  - **[Bug Fix]** 등반 시작 시 캐릭터 레벨이 1로 표시되는 오류 수정.
  - **[Bug Fix]** 등반 중 획득한 임시 스탯이 영구적으로 누적되는 치명적인 오류 수정.
  - **[Finalize]** 등반 시스템의 3대 핵심 기능(영구 데이터 로드, 세션 데이터 유지, 자유로운 캐릭터 행동 선택) 최종 동작 확인.

Phase 4.24 (Contents & Asset Expansion) [사용자가 상시 수행/PM 및 GCA 개입 없음]:
- **Goal:** 신규 캐릭터 및 스테이지 에셋을 추가하고, 게임 콘텐츠를 확장. (GCA 개입 없음)
- **Tasks (필요한 이미지 리소스 목록):** 
  - **1. 캐릭터 이미지 (아군/적군):**
    - 전신이 잘 보이도록 제작 (권장 크기: 200x240 픽셀, 5:6 비율)
  - **2. 전투 효과(VFX) 이미지:**
    - 일반 공격 타격 (예: `slash.png`, `hit.png`)
    - 스킬/필살기 타격 효과
  - **3. UI 요소 이미지:**
    - 뽑기 버튼 4종 (예: `btn_gacha_1_normal.png` 등)
  - **4. 게임 아이콘:**
    - 실행 파일(.exe) 및 창 아이콘 (예: `game_icon.ico`)

Phase 4.25 (System Framework Prerequisite) [Done]:
- **Goal:** 이미지/사운드 등 리소스가 없는 상태에서도 게임이 정상 작동하도록 시스템 프레임워크를 선행 개발.
- **Tasks:**
  - **[New] 오디오 시스템 Placeholder 구현 (`ui/audio_manager.py`):** 사운드 파일이 없을 경우, 오류 대신 로그만 남기고 정상 진행되도록 `AudioManager` 구현.
  - **[New] VFX 시스템 Placeholder 구현 (`ui/vfx.py`):** `VFXManager`를 구현하고, 피격 시 '빨간색 사각형' 이펙트가 표시되도록 하여 시각적 피드백 기반 마련.
  - **[Refactor] 이미지 로딩 방어 로직 추가 (`ui/components.py`, `scenes/gacha_scene.py`):** 이미지 파일이 없을 때 '회색 사각형'과 '캐릭터 이름'이 대신 표시되도록 수정하여 UI 깨짐 방지.
  - **[Bug Fix]** 리팩토링 과정에서 발생한 `gacha_scene`의 버튼 동작 오류 및 `battle_scene`의 '이어하기' 오류 수정.

Phase 4.5 (Background Music Implementation) [Done]:
- Goal: 게임의 분위기와 몰입도를 높이기 위한 배경 음악(BGM) 시스템 구현 및 적용.
- Tasks:
  - **[Done]** AudioManager 고도화: BGM 스트리밍 재생, 중복 방지, 크로스페이드, 무한 루프 기능이 포함된 `play_bgm` 메소드 구현 완료.
  - **[Done]** 다이내믹 BGM 로직: `StageManager`에 `get_current_bgm_name` 메소드를 구현하여, 층과 테마에 따라 동적으로 BGM을 결정하는 로직 구현 완료.
  - **[Done]** 씬별 적용: 로비, 뽑기 등 비전투 씬과 각 테마별 전투 씬의 진입 시점에 BGM이 정상적으로 재생되도록 연동 완료.

**Phase 4.6 (Sound Effects Implementation) [In Progress]:**
- **Goal:** 조작감과 타격감을 높이기 위한 효과음(SFX) 시스템 구현 및 안정화.
- **Tasks:**
    - **[Done]** `AudioManager`에 효과음 캐싱 및 재생을 위한 `play_sfx` 메소드 구현 완료.
    - **[Done]** `FighterData`에 `sfx_type` 필드를 추가하고, 데이터에 따라 공격/스킬/필살기 사운드가 동적으로 분기되도록 구현 완료.
    - **[Done]** UI 버튼 클릭, 뽑기 연출 등 게임 내 주요 상호작용에 효과음 연동 완료.
    - **[Done]** 전투 중 타격감 강화를 위해 공격/스킬/필살기별 볼륨을 차등 적용.
    - **[Done]** 전투 화면에 BGM/SFX 음소거 토글 버튼을 추가하여 편의성 개선.

Phase 5 (Image Integration & Verification) [Development Required]:
- Goal: 준비된 리소스가 게임 내에서 정상적으로 로드되는지 '상세 보기' 화면을 통해 검증.
- Tasks:
  - CharacterDetailPopup에 실제 이미지 파일(fighter_data.image_path) 연동.
  - 이미지가 없는 경우를 대비한 'Placeholder(대체 이미지)' 처리 로직 추가.
  - 리소스 경로 로딩 테스트 (파일명 매칭 확인).

Phase 6 (Gacha Scene Visualization) [Development Required]:
- Goal: 10회/1회 뽑기 화면의 UI 레이아웃을 재구성하고 연출을 고도화.
- Tasks:
  - 10회 뽑기: 배경(bg_gacha_10.png)의 제단 위치에 맞춰 캐릭터/텍스트 좌표 정밀 보정 (하드코딩).
  - 1회 뽑기: 배경(bg_gacha_1.png) 중앙 제단에 캐릭터 등장 연출 구현.
  - 등급별 텍스트 색상 및 이펙트(간단한 빛 효과 등) 적용.

Phase 7 (Visual Effects - VFX) [Development Required]:
- Goal: 전투의 타격감과 상황 전달력을 높이기 위한 시각 효과 구현.
- Tasks:
  - VFXManager 고도화 및 이펙트 이미지(타격, 참격 등) 연동.
  - 공격(Attack), 스킬(Skill), 피격(Hit), 회복(Heal) 시 애니메이션/플로팅 텍스트 연출 적용.
  - 화면 흔들림(Camera Shake) 등 연출 효과 추가.
  
[Checkpoint] (Technical Deployment Test) [Test Build]:
- Goal: 리소스가 포함된 상태에서 실행 파일(.exe)이 정상 작동하는지 기술적 검증.
- Tasks:
  - PyInstaller를 사용하여 테스트 빌드 생성.
  - _internal 폴더 내 이미지/사운드 경로 인식 여부 확인.
  - 외부 PC 실행 테스트 (가능 시).

Phase 8 (Climb Balance Tuning) [Data Adjustment]:
- Goal: 100층 등반의 난이도 곡선 조정 (초반 진입장벽 완화).
- Tasks:
  - 층별 적(Enemy)의 HP/ATK 성장 곡선 조정.
  - 10층 단위 보스 몬스터의 난이도 및 패턴 빈도 조절.

Phase 9 (Character Balance Tuning) [Data Adjustment]:
- Goal: 캐릭터 간 성능 차별화 및 등급(Grade) 밸런스 확립.
- Tasks:
  - 등급별(Mythic ~ Common) 기본 스탯 격차 조정.
  - 캐릭터별 스킬 발동 확률 및 계수 조정.

Phase 10 (Growth Balance Tuning) [Data Adjustment]:
- Goal: 레벨업에 따른 성장 체감 속도 조절.
- Tasks:
  - 레벨업 필요 경험치 공식 조정.
  - 레벨당 스탯 상승폭(Growth Rate) 미세 조정.

Phase 11 (Final Deployment) [Release]:
- Goal: 최종 사용자(아들)에게 전달할 배포 파일 생성.
- Tasks:
  - 디버그 코드(로그 출력 등) 제거 및 최적화.
  - 최종 PyInstaller 패키징.
  - 아이콘 적용 및 파일명 확정.

7. 주요 용어 정의 (Glossary)
(기존과 동일)