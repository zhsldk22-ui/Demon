📘 DGFS 기술 명세서: 코드 구조 및 로직 흐름 (Ver 4.3)
1. 모듈별 상세 역할 정의 (Module Roles)
DGFS 프로젝트는 관심사의 분리(Separation of Concerns) 원칙에 따라 8개의 핵심 모듈로 확장 구성되어 있습니다.
1.1. config.py (Configuration)
역할: 게임의 **'상수(Constants) 저장소'**이자 '환경 설정 파일'.
핵심 내용:
SCREEN_WIDTH, FPS: 해상도(1280x720) 및 프레임 설정.
WHITE, RED, GRAY: UI 및 체력바에 사용되는 색상 RGB 값.
BASE_DIR, ASSETS_DIR: OS 독립적인 절대 경로 계산.
중요성: 모든 파일이 참조하며, 해상도나 경로 변경 시 이 파일만 수정하면 전역 반영됩니다.
1.2. database.py (Data Access Layer)
역할: '데이터 관리자'. 기획 데이터(CSV)와 인게임 데이터(SQLite) 사이의 브리지 역할을 수행합니다.
핵심 업데이트:
init_db(): users, inventory, used_coupons 외에 characters, enemies 테이블 스키마 관리.
New Columns:
enemies: tier (난이도), role (MOB/BOSS).
inventory: is_selected (덱 장착 여부).
중요성: enemies.csv 수정만으로 게임 밸런스(티어, 역할)를 즉시 패치할 수 있습니다.
1.3. ui/components.py (UI Library)
역할: 재사용 가능한 'UI 부품 공장'.
핵심 클래스:
Button: 마우스 오버/클릭 이벤트를 처리하는 버튼 객체.
InputBox: 쿠폰 입력 등에 사용되는 텍스트 입력 필드.
1.4. game_systems/battle.py (Core Logic Engine)
역할: **'전투 엔진'**이자 '로그라이크 룰 관리자'.
상태: 2:2 전투 및 로그라이크 하드코어 룰 구현 완료.
핵심 로직:
2 vs 2 Battle: 아군 2명(선택된 덱) vs 적군 2명(일반) 또는 1명(보스).
Permadeath (사망 패널티): 전투 중 HP가 0이 된 캐릭터는 해당 챕터(10층 단위) 내내 부활 불가.
Full Restore (완전 회복): 10층 단위 보스 클리어 시, 사망자를 포함한 파티 전원 부활 및 HP 100% 회복.
Stage Integration: StageManager에게 현재 층의 적 정보를 요청하여 스폰.
1.5. game_systems/stage_manager.py (Stage Logic) [New]
역할: '맵 생성기'. 100층 등반의 바이옴 순서와 적 난이도를 제어합니다.
핵심 로직 (get_stage_info):
Biome Shuffle: 30층 단위(Phase)로 바이옴 순서를 랜덤하게 섞음.
Tier Scaling: 층수에 따라 적의 등급(Tier 1~3)을 결정.
Boss Spawning: 10층 단위 및 90층 이상 구간의 고정/랜덤 보스 출현 관리.
1.6. game_systems/gacha.py (Economy System) [New]
역할: '확률형 아이템 생성기'.
핵심 로직 (draw_10):
Weighted RNG: 등급별 확률(Mythic ~ Common)에 따라 10회 추첨.
Inventory Save: 뽑힌 캐릭터를 DB inventory 테이블에 즉시 저장.
1.7. game_systems/coupon.py (Economy System)
역할: '오프라인 보상 검증기'.
로직: DAD251201N 형식의 코드를 파싱하여 유효성을 검증하고 티켓을 지급.
1.8. main.py (Application Entry Point)
역할: '지휘자(Conductor)'. 게임의 상태(State) 관리 및 화면 전환.
상태 관리 (game_state):
"LOBBY", "BATTLE", "COUPON_POPUP"
"GACHA_RESULT" [New]: 10연차 결과 화면 출력.
"DECK_VIEW" [New]: 보유 캐릭터 목록 확인 및 출전 캐릭터 선택(Click to Toggle).
2. 코드 실행 및 로직 흐름도 (Execution Flow)
2.1. 게임 시작 (Startup Sequence)
main.py 실행 → init_db() (DB 갱신) → 로비 진입.
2.2. 덱 관리 및 가챠 (Deck & Gacha Flow) [New]
Gacha: 로비 [소환 상점] 클릭 → GachaManager.draw_10() → 결과 화면 → 인벤토리 저장.
Deck Select: 로비 [내 덱 보기] 클릭 → 캐릭터 클릭하여 is_selected=1 토글 (최대 2명).
2.3. 전투 루프 (Battle Loop)
Init: BattleScene 생성.
Party Load: DB에서 is_selected=1인 캐릭터 로드 (없으면 랜덤 2명).
Enemy Spawn: StageManager가 결정한 Biome/Tier/Role에 맞춰 DB에서 적 소환.
Battle:
턴 큐(Turn Queue)에 따라 공격 진행.
사망한 아군은 fighters 목록에서 제외 (전투 불능).
End Game:
승리: 보상 선택(HP/스탯) → floor += 1 → 다음 층 적 생성.
보스 클리어: 10층 단위 승리 시 full_restore_party() 발동.
패배: 아군 전멸 시 로비로 복귀 (튜토리얼일 경우 보상 지급).
2.4. 향후 개발 과제 (Phase 3.7 Requirement)
스킬 시스템: 현재는 평타 공격만 존재. MP를 소모하는 '액티브 스킬'과 SP를 소모하는 '필살기' 구현 필요.
연출 강화: 스킬 사용 시 컷신이나 대사 출력 등 시각적 피드백 강화.

